/**
 * Created by yizheng on 2018/9/29.
 */
// mapboxgl.accessToken = 'NOT-REQUIRED-WITH-YOUR-VECTOR-TILES-DATA';

const OSM_SERVER = "http://c.tile.openstreetmap.org/{z}/{x}/{y}.png"
const MAPBOX_RASTER_TILE_SERVER = "mapbox://mapbox.satellite";
const TDD_SATELLITE_TILE_SERVER = "http://t1.tianditu.cn/DataServer?T=img_w&x={x}&y={y}&l={z}";
const TDD_VECTOR_CVA_SERVER = "http://t0.tianditu.com/DataServer?T=cva_c&x={x}&y={y}&l={z}";
const MIN_VALUE = -15;
const MAX_VALUE = 15;


mapboxgl.accessToken = 'pk.eyJ1IjoiZmx1dHRlcmJvYiIsImEiOiJjaXc0anRvYmkwMDAxMnltZ3N3OTYzNWpuIn0.qHA6K6Ix57mWsf5R2YR6MQ';

var color_table = [
    [124,	0,	255],
    [124,	0,	255],
    [120,	0,	255],
    [115,	0,	255],
    [111,	0,	255],
    [106,	0,	255],
    [102,	0,	255],
    [97,	0,	255],
    [93,	0,	255],
    [88,	0,	255],
    [84,	0,	255],
    [79,	0,	255],
    [75,	0,	255],
    [70,	0,	255],
    [66,	0,	255],
    [61,	0,	255],
    [57,	0,	255],
    [52,	0,	255],
    [48,	0,	255],
    [43,	0,	255],
    [39,	0,	255],
    [34,	0,	255],
    [30,	0,	255],
    [25,	0,	255],
    [21,	0,	255],
    [16,	0,	255],
    [12,	0,	255],
    [7,	0,	255],
    [3,	0,	255],
    [0,	2,	255],
    [0,	6,	255],
    [0,	11,	255],
    [0,	15,	255],
    [0,	20,	255],
    [0,	24,	255],
    [0,	29,	255],
    [0,	33,	255],
    [0,	38,	255],
    [0,	42,	255],
    [0,	47,	255],
    [0,	51,	255],
    [0,	56,	255],
    [0,	60,	255],
    [0,	65,	255],
    [0,	69,	255],
    [0,	74,	255],
    [0,	78,	255],
    [0,	83,	255],
    [0,	87,	255],
    [0,	92,	255],
    [0,	96,	255],
    [0,	101,	255],
    [0,	105,	255],
    [0,	110,	255],
    [0,	114,	255],
    [0,	119,	255],
    [0,	123,	255],
    [0,	128,	255],
    [0,	132,	255],
    [0,	137,	255],
    [0,	141,	255],
    [0,	146,	255],
    [0,	150,	255],
    [0,	155,	255],
    [0,	159,	255],
    [0,	164,	255],
    [0,	168,	255],
    [0,	173,	255],
    [0,	177,	255],
    [0,	182,	255],
    [0,	186,	255],
    [0,	191,	255],
    [0,	195,	255],
    [0,	200,	255],
    [0,	204,	255],
    [0,	209,	255],
    [0,	213,	255],
    [0,	218,	255],
    [0,	222,	255],
    [0,	227,	255],
    [0,	231,	255],
    [0,	236,	255],
    [0,	241,	255],
    [0,	245,	255],
    [0,	250,	255],
    [0,	254,	255],
    [0,	255,	251],
    [0,	255,	247],
    [0,	255,	242],
    [0,	255,	238],
    [0,	255,	233],
    [0,	255,	229],
    [0,	255,	224],
    [0,	255,	220],
    [0,	255,	215],
    [0,	255,	211],
    [0,	255,	206],
    [0,	255,	202],
    [0,	255,	197],
    [0,	255,	193],
    [0,	255,	188],
    [0,	255,	184],
    [0,	255,	179],
    [0,	255,	175],
    [0,	255,	170],
    [0,	255,	166],
    [0,	255,	161],
    [0,	255,	157],
    [0,	255,	152],
    [0,	255,	148],
    [0,	255,	143],
    [0,	255,	139],
    [0,	255,	134],
    [0,	255,	130],
    [0,	255,	125],
    [0,	255,	121],
    [0,	255,	116],
    [0,	255,	112],
    [0,	255,	107],
    [0,	255,	103],
    [0,	255,	98],
    [0,	255,	94],
    [0,	255,	89],
    [0,	255,	85],
    [0,	255,	80],
    [0,	255,	76],
    [0,	255,	71],
    [0,	255,	67],
    [0,	255,	62],
    [0,	255,	58],
    [0,	255,	53],
    [0,	255,	49],
    [0,	255,	44],
    [0,	255,	40],
    [0,	255,	35],
    [0,	255,	31],
    [0,	255,	26],
    [0,	255,	22],
    [0,	255,	17],
    [0,	255,	13],
    [0,	255,	8],
    [0,	255,	4],
    [1,	255,	0],
    [5,	255,	0],
    [13,	255,	0],
    [14,	255,	0],
    [19,	255,	0],
    [23,	255,	0],
    [28,	255,	0],
    [32,	255,	0],
    [37,	255,	0],
    [41,	255,	0],
    [46,	255,	0],
    [50,	255,	0],
    [55,	255,	0],
    [59,	255,	0],
    [64,	255,	0],
    [68,	255,	0],
    [73,	255,	0],
    [77,	255,	0],
    [82,	255,	0],
    [86,	255,	0],
    [91,	255,	0],
    [95,	255,	0],
    [100,	255,	0],
    [104,	255,	0],
    [109,	255,	0],
    [113,	255,	0],
    [118,	255,	0],
    [123,	255,	0],
    [127,	255,	0],
    [132,	255,	0],
    [136,	255,	0],
    [141,	255,	0],
    [145,	255,	0],
    [150,	255,	0],
    [154,	255,	0],
    [159,	255,	0],
    [163,	255,	0],
    [168,	255,	0],
    [172,	255,	0],
    [177,	255,	0],
    [181,	255,	0],
    [186,	255,	0],
    [190,	255,	0],
    [195,	255,	0],
    [199,	255,	0],
    [204,	255,	0],
    [208,	255,	0],
    [213,	255,	0],
    [217,	255,	0],
    [222,	255,	0],
    [226,	255,	0],
    [231,	255,	0],
    [235,	255,	0],
    [240,	255,	0],
    [244,	255,	0],
    [249,	255,	0],
    [253,	255,	0],
    [255,	252,	0],
    [255,	248,	0],
    [255,	243,	0],
    [255,	239,	0],
    [255,	234,	0],
    [255,	230,	0],
    [255,	225,	0],
    [255,	221,	0],
    [255,	216,	0],
    [255,	212,	0],
    [255,	207,	0],
    [255,	203,	0],
    [255,	198,	0],
    [255,	194,	0],
    [255,	189,	0],
    [255,	185,	0],
    [255,	180,	0],
    [255,	176,	0],
    [255,	171,	0],
    [255,	167,	0],
    [255,	162,	0],
    [255,	158,	0],
    [255,	153,	0],
    [255,	149,	0],
    [255,	144,	0],
    [255,	140,	0],
    [255,	135,	0],
    [255,	131,	0],
    [255,	126,	0],
    [255,	122,	0],
    [255,	117,	0],
    [255,	113,	0],
    [255,	108,	0],
    [255,	104,	0],
    [255,	99,	0],
    [255,	95,	0],
    [255,	90,	0],
    [255,	86,	0],
    [255,	81,	0],
    [255,	77,	0],
    [255,	72,	0],
    [255,	68,	0],
    [255,	63,	0],
    [255,	59,	0],
    [255,	54,	0],
    [255,	50,	0],
    [255,	45,	0],
    [255,	41,	0],
    [255,	36,	0],
    [255,	32,	0],
    [255,	27,	0],
    [255,	23,	0],
    [255,	18,	0],
    [255,	14,	0],
    [255,	9,	0],
    [255,	5,	0],
    [255,	5,	0]
];

var stops_table = function () {
    var length = color_table.length;
    var duration = MAX_VALUE - MIN_VALUE;
    var currentValue = MIN_VALUE;
    var stop_value_plus = duration/length;
    var result = [];
    for (i = 0;i<length;i++) {
        if (i!=0)
            currentValue += stop_value_plus;
        var color = color_table[length-i-1];
        var stop = [currentValue, "rgb(" + color[0] + "," + color[1] + "," + color[2] + ")"];
        result.push(stop);
    }
    return result;
};


var basemap_style = {
    "version": 8,
    "name": "basemap_style",
    sources: {
        "tdt_statellite": {
            "type": "raster",
            "tiles": [
                TDD_SATELLITE_TILE_SERVER
            ],
            "tileSize": 256
        },
        "vector_source": {
            "type": "vector",
            "tiles": ["http://localhost:8080/tile/{z}/{x}/{y}.pbf"]
        }
    },
    layers: [
        {
            "id": "satellite",
            "source": "tdt_statellite",
            "source-layer": "satellite",
            "type": "raster",
        },
        {
            "id": "pois",
            "source": "vector_source",
            "source-layer": "airport",
            "type": "circle",
            "paint": {
                "circle-radius": [
                    "interpolate",
                    [
                        "linear"
                    ],
                    [
                        "zoom"
                    ],
                    0,
                    1,
                    16,
                    3
                ],
                // "circle-color": [
                //     "interpolate",
                //     [
                //         "linear"
                //     ],
                //     [
                //         "get",
                //         "dv(mm/y)"
                //     ],
                //     -15.020866394043,
                //     "hsl(0, 88%, 69%)",
                //     15.979133605957,
                //     "hsl(250, 68%, 48%)"
                // ],
                "circle-color":{
                    "property":"dv(mm/y)",
                    "stops":stops_table()
                }
                // "circle-blur": 0.8
            }
        }
    ]
};


var map = new mapboxgl.Map({
    container: 'map',
    zoom: 13,
    center: [113.9213, 22.3084],
    style: basemap_style
});

map.on('mousedown', function (e) {
    var features = map.queryRenderedFeatures(e.point);
    document.getElementById('features').innerHTML = JSON.stringify(features, null, 2);
});

// map.addControl(new mapboxgl.Navigation());


